# κΈ°λ„ λ°μ΄ν„°λ¥Ό μ§€ν‚¤λ” λ°©λ²•

> κΈ°λ„λ” κ°μΈμ μΈ μμ—­μ…λ‹λ‹¤. μ„λ²„ μ΄μμμ΅°μ°¨λ„ μ‚¬μ©μμ κΈ°λ„ λ‚΄μ©μ„ λ³Ό μ μ—†μ–΄μ•Ό ν•λ‹¤κ³  μƒκ°ν–μµλ‹λ‹¤. μ΄ λ¬Έμ„λ” κ·Έ λ©ν‘λ¥Ό λ‹¬μ„±ν•κΈ° μ„ν• E2E μ•”νΈν™” μ„¤κ³„ κ³Όμ •μ„ μ •λ¦¬ν•©λ‹λ‹¤.

---

### μ”μ•½

| ν•­λ© | λ‚΄μ© |
|-----|-----|
| **λ©ν‘** | μ„λ²„λ„ ν‰λ¬Έμ„ λ³Ό μ μ—†λ” E2E μ•”νΈν™” |
| **λ¬Έμ ** | OAuth μ‚¬μ©μλ” λΉ„λ°€λ²νΈ μ—†μ / 6μλ¦¬ PINμ€ μ·¨μ•½ / λ©€ν‹° κΈ°κΈ° μ§€μ› ν•„μ” |
| **ν•΄κ²°** | PIN + Server Key ν•μ΄λΈλ¦¬λ“ β†’ DB μ μ¶λ§μΌλ΅λ” μ¤ν”„λΌμΈ κ³µκ²© λ¶κ°€ |
| **ν•κ³„** | μ„λ²„ μ „μ²΄ μΉ¨ν•΄ μ‹ PIN λΈλ£¨νΈν¬μ¤ κ°€λ¥ (10β¶ κ³µκ°„) |
| **λ°©μ–΄μ„ ** | PBKDF2 600k iterations, μΉ¨ν•΄ νƒμ§€, ν–¥ν›„ KMS/HSM |

---

## μ™ E2E μ•”νΈν™”μΈκ°€?

### λ―Όκ°ν• λ°μ΄ν„°μ λ³Έμ§

κΈ°λ„μ λ©κ³Ό κΈ°λ„λ¬Έμ—λ” μ‚¬μ©μμ κ°€μ¥ κ°μΈμ μΈ κ³ λ―Ό, κ°μ‚¬, κ°„κµ¬κ°€ λ‹΄κΉλ‹λ‹¤. μ΄λ° λ°μ΄ν„°κ°€ μ„λ²„μ— ν‰λ¬ΈμΌλ΅ μ €μ¥λλ‹¤λ©΄:

- μ„λ²„ μ΄μμκ°€ μ–Έμ λ“  μ—΄λ κ°€λ¥
- λ°μ΄ν„°λ² μ΄μ¤ μ μ¶ μ‹ λ¨λ“  λ‚΄μ© λ…Έμ¶
- λ°±μ—… νμΌμ—λ„ ν‰λ¬ΈμΌλ΅ μ΅΄μ¬

**μ„λ²„λ¥Ό μ‹ λΆ°ν•  μ μ—†λ” ν™κ²½μΌλ΅ κ°€μ •**ν•κ³  μ„¤κ³„ν•΄μ•Ό ν–μµλ‹λ‹¤. μ„λ²„κ°€ ν•΄ν‚Ήλ‹Ήν•λ”λΌλ„, μ‹¬μ§€μ–΄ μ„λ²„ μ΄μμ(λ‚ μμ‹ )λΌλ„ μ‚¬μ©μμ κΈ°λ„ λ‚΄μ©μ„ λ³Ό μ μ—†μ–΄μ•Ό ν•©λ‹λ‹¤.

---

## λ§μ£ΌμΉ λ¬Έμ λ“¤

### λ¬Έμ  1: OAuthμ™€ E2E μ•”νΈν™”μ μ¶©λ

Selahλ” Google, μΉ΄μΉ΄μ¤ OAuth λ΅κ·ΈμΈμ„ μ§€μ›ν•κ³  μ‹¶μ—μµλ‹λ‹¤. μ†μ… λ΅κ·ΈμΈμ€ μ‚¬μ©μ κ²½ν—μ΄ μΆ‹κ³ , λΉ„λ°€λ²νΈ κ΄€λ¦¬ λ¶€λ‹΄μ„ μ¤„μ—¬μ¤λ‹λ‹¤.

ν•μ§€λ§ OAuth μ‚¬μ©μλ” **Selahμ— λΉ„λ°€λ²νΈκ°€ μ—†μµλ‹λ‹¤.** μ•”νΈν™” ν‚¤λ¥Ό μ–΄λ””μ„ νμƒν•΄μ•Ό ν• κΉμ”?

```
μ΄λ©”μΌ λ΅κ·ΈμΈ μ‚¬μ©μ: λΉ„λ°€λ²νΈ μμ β†’ ν‚¤ νμƒ κ°€λ¥ β“
OAuth λ΅κ·ΈμΈ μ‚¬μ©μ: λΉ„λ°€λ²νΈ μ—†μ β†’ ν‚¤ νμƒ λ¶κ°€ π’€
```

λ‘ κ°€μ§€ μ„ νƒμ§€κ°€ μμ—μµλ‹λ‹¤:

1. **OAuth μ‚¬μ©μμ—κ²λ„ λ³„λ„ λΉ„λ°€λ²νΈ μ”κµ¬** β†’ μ†μ… λ΅κ·ΈμΈμ νΈμμ„± μƒμ‹¤
2. **μΈμ¦κ³Ό μ•”νΈν™”λ¥Ό λ¶„λ¦¬** β†’ λ³„λ„μ μ•”νΈν™” PIN λ„μ…

### λ¬Έμ  2: 6μλ¦¬ PINμ μ·¨μ•½μ„±

κ·Έλμ„ λ³„λ„μ "μ•”νΈν™” PIN"μ„ λ„μ…ν•κΈ°λ΅ ν–μµλ‹λ‹¤. μ‚¬μ©μ„±μ„ μ„ν•΄ 6μλ¦¬ μ«μλ΅ μ ν•ν–μµλ‹λ‹¤.

ν•μ§€λ§ 6μλ¦¬ PINμ€ 1,000,000κ°€μ§€ μ΅°ν•©λ°–μ— μ—†μµλ‹λ‹¤:

```
Salt + μ•”νΈν™”λ DEKκ°€ μ μ¶λλ©΄?
    β†“
κ³µκ²©μκ°€ μ¤ν”„λΌμΈμ—μ„ 100λ§ λ² μ‹λ„
    β†“
PIN κ³µκ°„μ΄ μ‘μ•„ κ³µκ²© λΉ„μ©μ΄ λ‚®μ π’€
```

### λ¬Έμ  3: λ©€ν‹° κΈ°κΈ° μ§€μ›

μ‚¬μ©μκ°€ μ—¬λ¬ κΈ°κΈ°μ—μ„ λ™μΌν• λ°μ΄ν„°μ— μ ‘κ·Όν•λ ¤λ©΄ **DEKλ¥Ό λ³µμ›ν•  μ μμ–΄μ•Ό** ν•©λ‹λ‹¤. ν•μ§€λ§ DEKλ¥Ό μ„λ²„μ— ν‰λ¬ΈμΌλ΅ μ €μ¥ν•λ©΄ E2Eκ°€ λ¬΄λ„μ§‘λ‹λ‹¤.

---

## ν•΄κ²°: PIN + Server Key ν•μ΄λΈλ¦¬λ“

### ν•µμ‹¬ μ•„μ΄λ””μ–΄

**ν΄λΌμ΄μ–ΈνΈλ§ μ•„λ” κ²ƒ(PIN)**κ³Ό **μ„λ²„λ§ μ•„λ” κ²ƒ(Server Key)**μ„ κ²°ν•©ν•©λ‹λ‹¤.

```
β”β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
β”‚  Hybrid Key Derivation                                      β”‚
β”β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”¤
β”‚                                                             β”‚
β”‚   [6-digit PIN] + [Salt]                                    β”‚
β”‚         β”‚                                                   β”‚
β”‚         β–Ό PBKDF2 (600,000 iterations)                       β”‚
β”‚   [Client KEK] β”€β”€β”€β”€β”€β”€β”                                      β”‚
β”‚                      β”‚                                      β”‚
β”‚   [Server Key] β”€β”€β”€β”€β”€β”€β”Όβ”€β”€β–¶ HKDF β”€β”€β–¶ [Combined KEK]           β”‚
β”‚   (From Server)      β”‚              β”‚                       β”‚
β”‚                                     β–Ό                       β”‚
β”‚                            AES-256-GCM Encryption           β”‚
β”‚                                     β”‚                       β”‚
β”‚                              [Encrypted DEK]                β”‚
β”‚                                                             β”‚
β””β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
```

### μ™ μ΄ λ°©μ‹μ΄ μ•μ „ν•κ°€?

| κ³µκ²© μ‹λ‚λ¦¬μ¤       | κ³µκ²©μκ°€ κ°€μ§„ κ²ƒ           | λ¶€μ΅±ν• κ²ƒ           | κ²°κ³Ό                                 |
|---------------|---------------------|-----------------|------------------------------------|
| DB μ μ¶         | Salt, Encrypted DEK | Server Key, PIN | μ¤ν”„λΌμΈ κ³µκ²© λ¶κ°€ (Server Key λ¶€μ¬)         |
| μ„λ²„ μΉ¨ν•΄         | Server Key          | Salt, DEK, PIN  | λ³µνΈν™” λ¶κ°€ (μ•”νΈλ¬Έ λ¶€μ¬)                    |
| DB + μ„λ²„ λ™μ‹ μΉ¨ν•΄ | λ¨λ“  μ„λ²„ λ°μ΄ν„°           | PIN             | PIN μ¤ν”„λΌμΈ λΈλ£¨νΈν¬μ¤ κ°€λ¥ (10β¶ κ³µκ°„, KDF λΉ„μ©) |

**DB μ μ¶λ§μΌλ΅λ” μ¤ν”„λΌμΈ λΈλ£¨νΈν¬μ¤κ°€ λ¶κ°€λ¥ν•©λ‹λ‹¤.** κ³µκ²©μκ°€ DBλ¥Ό ν†µμ§Έλ΅ κ°€μ Έκ°€λ„ Server Key μ—†μ΄λ” λ΅μ»¬μ—μ„ PINμ„ μ‹λ„ν•΄λ³Ό μ μ—†μµλ‹λ‹¤.

λ‹¨, **μ„λ²„(μ• ν”λ¦¬μΌ€μ΄μ…/Master Key)κΉμ§€ μΉ¨ν•΄**λμ–΄ Server Key ν‰λ¬Έμ„ μ–»λ” κ²½μ°, PIN κ³µκ°„(10β¶)μ— λ€ν• μ¤ν”„λΌμΈ λΈλ£¨νΈν¬μ¤κ°€ κ°€λ¥ν•΄μ§‘λ‹λ‹¤. μ΄ κ²½μ°μ λ°©μ–΄μ„ μ€ Rate Limitμ΄ μ•„λ‹λΌ
**KDF λΉ„μ©(PBKDF2 600k iterations)**, **μΉ¨ν•΄ νƒμ§€/κ²©λ¦¬**, **Master Key λ³΄νΈ(ν–¥ν›„ KMS/HSM)**μ…λ‹λ‹¤.

---

## ν‚¤ κ³„μΈµ κµ¬μ΅°

### μ „μ²΄ κ·Έλ¦Ό

```
β”β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
β”‚                        Key Hierarchy                        β”‚
β”β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”¤
β”‚                                                             β”‚
β”‚  [DEK] Data Encryption Key (256-bit AES)                    β”‚
β”‚    β”‚                                                        β”‚
β”‚    β”‚  - Generated once at signup                            β”‚
β”‚    β”‚  - Used to encrypt prayer data                         β”‚
β”‚    β”‚  - Cached in browser IndexedDB                         β”‚
β”‚    β”‚                                                        β”‚
β”‚    β”β”€β”€β–¶ Encrypted with [Combined KEK] β†’ encryptedDEK        β”‚
β”‚    β””β”€β”€β–¶ Encrypted with [Recovery Key] β†’ recoveryEncryptedDEKβ”‚
β”‚                                                             β”‚
β”β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”¤
β”‚                                                             β”‚
β”‚  [Client KEK] = PBKDF2(6-digit PIN + Salt)                  β”‚
β”‚    β”‚                                                        β”‚
β”‚    β”‚  - Generated only on client                            β”‚
β”‚    β”‚  - Never sent to server                                β”‚
β”‚    β”‚  - Discarded after use                                 β”‚
β”‚    β”‚                                                        β”‚
β”‚    β””β”€β”€β–¶ Combined with [Server Key] β†’ Combined KEK           β”‚
β”‚                                                             β”‚
β”β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”¤
β”‚                                                             β”‚
β”‚  [Server Key] Random 256-bit key from server                β”‚
β”‚                                                             β”‚
β”‚       - Encrypted with Master Key, stored in DB             β”‚
β”‚       - Re-issued on PIN change                             β”‚
β”‚       - Prevents offline brute-force attacks                β”‚
β”‚                                                             β”‚
β”β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”¤
β”‚                                                             β”‚
β”‚  [Recovery Key] High-entropy random string                  β”‚
β”‚                                                             β”‚
β”‚       - Shown only once at signup                           β”‚
β”‚       - Only hash stored on server                          β”‚
β”‚       - Used to recover DEK if PIN is lost                  β”‚
β”‚                                                             β”‚
β””β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
```

### ν‚¤λ³„ μ €μ¥ μ„μΉ

| ν‚¤            | μ €μ¥ μ„μΉ           | μ„λ²„κ°€ ν‰λ¬Έμ„ μ•„λ”κ°€?          |
|--------------|-----------------|-----------------------|
| DEK          | ν΄λΌμ΄μ–ΈνΈ IndexedDB | β μ•”νΈλ¬Έλ§ μ €μ¥             |
| Client KEK   | λ©”λ¨λ¦¬ (μΌμ‹μ )       | β μ „μ†΅ μ•ν•¨               |
| Server Key   | μ„λ²„ DB (μ•”νΈν™”)     | β οΈ Master Keyλ΅ λ³µνΈν™” κ°€λ¥ |
| Combined KEK | λ©”λ¨λ¦¬ (μΌμ‹μ )       | β μƒμ„± μ•ν•¨               |
| Recovery Key | μ‚¬μ©μ λ³΄κ΄€          | β ν•΄μ‹λ§ μ €μ¥              |
| Salt         | μ„λ²„ DB           | β… (μ•”νΈν™” ν‚¤ μ•„λ‹)          |

---

## μ•”νΈν™” μ•κ³ λ¦¬μ¦

| μ©λ„              | μ•κ³ λ¦¬μ¦          | νλΌλ―Έν„°                             |
|-----------------|---------------|----------------------------------|
| Client KEK νμƒ   | PBKDF2-SHA256 | 600,000 iterations, 32-byte salt |
| Combined KEK μƒμ„± | HKDF-SHA256   | 32-byte output                   |
| DEK μ•”νΈν™”         | AES-256-GCM   | 12-byte IV, 128-bit auth tag     |
| λ°μ΄ν„° μ•”νΈν™”         | AES-256-GCM   | 12-byte IV, 128-bit auth tag     |

---

## ν”λ΅μ°

### νμ›κ°€μ…: μ•”νΈν™” μ„¤μ •

```
[Signup / OAuth Complete]
        β†“
[Set 6-digit Encryption PIN]
        β†“
β”β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
β”‚ Client                                                      β”‚
β”‚   1. Generate random DEK (256-bit)                          β”‚
β”‚   2. Generate random Salt (32-byte)                         β”‚
β”‚   3. PIN + Salt β†’ Client KEK (PBKDF2)                       β”‚
β”‚   4. Generate random Recovery Key                           β”‚
β””β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
        β†“
β”β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
β”‚ Server Request: Generate Server Key                         β”‚
β”‚   - Server generates 256-bit Server Key                     β”‚
β”‚   - Encrypts with Master Key, stores in DB                  β”‚
β”‚   - Returns plaintext Server Key to client                  β”‚
β””β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
        β†“
β”β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
β”‚ Client                                                      β”‚
β”‚   5. Combined KEK = HKDF(Client KEK || Server Key)          β”‚
β”‚   6. encryptedDEK = AES-GCM(DEK, Combined KEK)              β”‚
β”‚   7. recoveryEncryptedDEK = AES-GCM(DEK, Recovery Key)      β”‚
β”‚   8. recoveryKeyHash = SHA256(Recovery Key)                 β”‚
β””β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
        β†“
β”β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
β”‚ Server Storage                                              β”‚
β”‚   - salt                                                    β”‚
β”‚   - encryptedDEK                                            β”‚
β”‚   - recoveryEncryptedDEK                                    β”‚
β”‚   - recoveryKeyHash                                         β”‚
β””β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
        β†“
[Show Recovery Key] - "This key can only be viewed now"
        β†“
[Cache DEK in IndexedDB]
        β†“
[Enter Home Screen]
```

### λ΅κ·ΈμΈ: μ κΈ ν•΄μ 

```
[Login (OAuth or Email)]
        β†“
[Check DEK cache in IndexedDB]
        β†“
β”β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”¬β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
β”‚  DEK exists (cached)      β”‚  DEK not found (new device)       β”‚
β”β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”Όβ”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”¤
β”‚                           β”‚                                   β”‚
β”‚  Use immediately β“        β”‚  Show PIN input screen            β”‚
β”‚                           β”‚         β†“                         β”‚
β”‚                           β”‚  Fetch salt, encryptedDEK,        β”‚
β”‚                           β”‚  serverKey from server            β”‚
β”‚                           β”‚         β†“                         β”‚
β”‚                           β”‚  Derive Client KEK                β”‚
β”‚                           β”‚         β†“                         β”‚
β”‚                           β”‚  Generate Combined KEK            β”‚
β”‚                           β”‚         β†“                         β”‚
β”‚                           β”‚  Decrypt DEK                      β”‚
β”‚                           β”‚         β†“                         β”‚
β”‚                           β”‚  Cache DEK in IndexedDB           β”‚
β”‚                           β”‚                                   β”‚
β””β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”΄β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
        β†“
[Enter Home Screen]
```

### λ°μ΄ν„° μ•”νΈν™”/λ³µνΈν™”

```
[μ €μ¥]
ν‰λ¬Έ β†’ DEKλ΅ AES-256-GCM μ•”νΈν™” β†’ IV + μ•”νΈλ¬Έ + AuthTag β†’ Base64 β†’ μ„λ²„ μ „μ†΅

[μ΅°ν]
μ„λ²„μ—μ„ Base64 μμ‹  β†’ λ””μ½”λ”© β†’ IV/μ•”νΈλ¬Έ/AuthTag λ¶„λ¦¬ β†’ DEKλ΅ λ³µνΈν™” β†’ ν‰λ¬Έ
```

### μ•”νΈν™” λ€μƒ ν•„λ“

| Entity      | μ•”νΈν™” ν•„λ“                |
|-------------|-----------------------|
| PrayerTopic | `title`, `reflection` |
| Prayer      | `content`             |

---

## λ³µκµ¬ λ©”μ»¤λ‹μ¦

### PIN λ¶„μ‹¤ μ‹

```
[PINμ„ μμ–΄λ²„λ Έμ–΄μ”]
     β†“
[Recovery Key μ…λ ¥]
     β†“
μ„λ²„μ—μ„ recoveryKeyHashλ΅ κ²€μ¦
     β†“
μ„λ²„μ—μ„ recoveryEncryptedDEK μ΅°ν
     β†“
ν΄λΌμ΄μ–ΈνΈμ—μ„ Recovery Keyλ΅ DEK λ³µνΈν™”
     β†“
[μƒ PIN μ„¤μ •]
     β†“
μƒ Salt, μƒ Server Keyλ΅ DEK μ¬μ•”νΈν™”
```

### PIN + Recovery Key λ¨λ‘ λ¶„μ‹¤ μ‹

**λ°μ΄ν„°λ¥Ό λ³µκµ¬ν•  μ μ—†μµλ‹λ‹¤.**

μ΄λ” μλ„λ μ μ•½μ…λ‹λ‹¤. μ„λ²„κ°€ ν‰λ¬Έμ„ μ• μ μ—†λ” κµ¬μ΅°λ¥Ό μ μ§€ν•λ ¤λ©΄, μ„λ²„λ„ λ°μ΄ν„°λ¥Ό λ³µκµ¬ν•  μ μ—†μ–΄μ•Ό ν•©λ‹λ‹¤.

---

## ν•κ³„ λ° Trade-off

E2E μ•”νΈν™”λ” κ³µμ§κ°€ μ•„λ‹™λ‹λ‹¤. λ³΄μ•μ„ μ–»λ” λ€μ‹  ν¬κΈ°ν•΄μ•Ό ν•λ” κ²ƒλ“¤μ΄ μμµλ‹λ‹¤.

### 1. λ³µκµ¬ λ¶κ°€λ¥μ„±

**ν•κ³„**: PINκ³Ό Recovery Keyλ¥Ό λ¨λ‘ λ¶„μ‹¤ν•λ©΄ λ°μ΄ν„°λ¥Ό μκµ¬ν μƒμµλ‹λ‹¤. μ„λ²„ μ΄μμλ„ λ³µκµ¬ν•΄μ¤„ μ μ—†μµλ‹λ‹¤.

**μ™ λ°›μ•„λ“¤μ€λ”κ°€**: μ΄κ²ƒμ΄ λ°”λ΅ E2E μ•”νΈν™”μ λ³Έμ§μ…λ‹λ‹¤. μ„λ²„κ°€ λ°μ΄ν„°λ¥Ό λ³µκµ¬ν•  μ μλ‹¤λ©΄, ν•΄μ»¤λ„ μ„λ²„λ¥Ό ν†µν•΄ λ³µκµ¬ν•  μ μλ‹¤λ” μλ―Έμ…λ‹λ‹¤.

```
"μ„λ²„κ°€ λ³µκµ¬ν•΄μ¤„ μ μλ‹¤" = "μ„λ²„κ°€ λ°μ΄ν„°μ— μ ‘κ·Όν•  μ μλ‹¤"
                        = "E2Eκ°€ μ•„λ‹λ‹¤"
```

μ‚¬μ©μμ—κ² Recovery Keyμ μ¤‘μ”μ„±μ„ λ…ν™•ν μ•λ‚΄ν•κ³ , μ•μ „ν• κ³³μ— λ³΄κ΄€ν•λ„λ΅ κ¶μ¥ν•©λ‹λ‹¤. λ°μ΄ν„°μ μµμΆ… μ±…μ„μ€ μ‚¬μ©μμ—κ² μμµλ‹λ‹¤. μ΄κ²ƒμ΄ μ§„μ •ν• ν”„λΌμ΄λ²„μ‹μ λ€κ°€μ…λ‹λ‹¤.

### 2. μ„λ²„ μμ΅΄μ„±

**ν•κ³„**: μƒ κΈ°κΈ°μ—μ„ DEKλ¥Ό λ³µμ›ν•λ ¤λ©΄ Server Keyκ°€ ν•„μ”ν•©λ‹λ‹¤. μ„λ²„κ°€ λ‹¤μ΄λλ©΄ μƒ κΈ°κΈ°μ—μ„ λ΅κ·ΈμΈν•  μ μ—†μµλ‹λ‹¤.

**μ™ λ°›μ•„λ“¤μ€λ”κ°€**: 6μλ¦¬ PINλ§μΌλ΅λ” μ¤ν”„λΌμΈ λΈλ£¨νΈν¬μ¤μ— μ·¨μ•½ν•©λ‹λ‹¤. Server Keyλ” μ΄ κ³µκ²©μ„ λ§‰κΈ° μ„ν• ν•„μ μ”μ†μ…λ‹λ‹¤.

| μ„ νƒμ§€              | μ¤ν”„λΌμΈ κ³µκ²© λ°©μ–΄   | μ„λ²„ μμ΅΄μ„±        |
|------------------|--------------|---------------|
| PINλ§ μ‚¬μ©          | π’€ κ³µκ²© λΉ„μ© λ‚®μ  | μ—†μ            |
| κΈ΄ λΉ„λ°€λ²νΈ μ‚¬μ©        | β…            | μ—†μ, ν•μ§€λ§ UX μ €ν• |
| PIN + Server Key | β… (DB μ μ¶ μ‹) | μμ            |

κΈ΄ λΉ„λ°€λ²νΈλ¥Ό μ”κµ¬ν•λ©΄ μ‚¬μ©μ„±μ΄ λ–¨μ–΄μ§€κ³ , OAuth μ‚¬μ©μμ—κ² λ λ‹¤λ¥Έ λΉ„λ°€λ²νΈλ¥Ό μ™Έμ°λΌκ³  ν•  μ μ—†μ—μµλ‹λ‹¤. Server Key μμ΅΄μ„±μ€ λ³΄μ•κ³Ό μ‚¬μ©μ„± μ‚¬μ΄μ κ· ν•μ μ…λ‹λ‹¤.

**μ™„ν™”μ±…**: DEKκ°€ μ΄λ―Έ IndexedDBμ— μΊμ‹λ κΈ°κΈ°μ—μ„λ” μ„λ²„ μ—†μ΄λ„ μ•”νΈν™”/λ³µνΈν™”κ°€ κ°€λ¥ν•©λ‹λ‹¤.

### 3. μ„λ²„ μΈ΅ κΈ°λ¥ μ ν•

**ν•κ³„**: μ„λ²„λ” μ•”νΈλ¬Έλ§ μ €μ¥ν•λ―€λ΅ μ„λ²„ μΈ΅μ—μ„ ν•  μ μλ” μΌμ΄ μ ν•λ©λ‹λ‹¤.

| κΈ°λ¥                       | κ°€λ¥ μ—¬λ¶€ | μ΄μ      |
|--------------------------|-------|--------|
| μ „λ¬Έ κ²€μƒ‰ (Full-text search) | β     | ν‰λ¬Έμ„ λ¨λ¦„ |
| λ°μ΄ν„° λ¶„μ„/ν†µκ³„                | β     | ν‰λ¬Έμ„ λ¨λ¦„ |
| ν‘Έμ‹ μ•λ¦Όμ— λ‚΄μ© ν¬ν•¨             | β     | ν‰λ¬Έμ„ λ¨λ¦„ |
| AI κΈ°λ° κΈ°λ¥                 | β     | ν‰λ¬Έμ„ λ¨λ¦„ |

**μ™ λ°›μ•„λ“¤μ€λ”κ°€**: μ΄ κΈ°λ¥λ“¤μ€ "μ„λ²„κ°€ λ°μ΄ν„°λ¥Ό μ½μ„ μ μμ–΄μ•Ό" κ°€λ¥ν•©λ‹λ‹¤. E2Eλ¥Ό μ„ νƒν• μκ°„ μ΄λ―Έ ν¬κΈ°ν• κ²ƒλ“¤μ…λ‹λ‹¤.

Selahλ” κ°μΈ κΈ°λ„ λ…ΈνΈμ…λ‹λ‹¤. μμ² κ°μ κΈ°λ„μ λ©μ„ κ²€μƒ‰ν•  μΌμ€ λ“λ¬Όκ³ , ν΄λΌμ΄μ–ΈνΈ μΈ΅ κ²€μƒ‰μΌλ΅ μ¶©λ¶„ν•©λ‹λ‹¤. AI λ¶„μ„λ³΄λ‹¤ ν”„λΌμ΄λ²„μ‹κ°€ λ” μ¤‘μ”ν•λ‹¤κ³  νλ‹¨ν–μµλ‹λ‹¤.

### 4. Server Key κ΄€λ¦¬ μ±…μ„

**ν•κ³„**: Server Keyκ°€ μ†μ‹¤λλ©΄ ν•΄λ‹Ή μ‚¬μ©μλ” μƒ κΈ°κΈ°μ—μ„ DEKλ¥Ό λ³µμ›ν•  μ μ—†μµλ‹λ‹¤.

**μ™ λ°›μ•„λ“¤μ€λ”κ°€**: μ΄κ±΄ μ§„μ§ ν•κ³„μ…λ‹λ‹¤. μ΄μ μ‹¤μλ΅ Server Keyλ¥Ό μƒμΌλ©΄ μ‚¬μ©μ λ°μ΄ν„°κ°€ μ κΉλ‹λ‹¤.

**μ™„ν™”μ±…**:

- Server Keyλ” Master Keyλ΅ μ•”νΈν™”λμ–΄ DBμ— μ €μ¥
- μ •κΈ°μ μΈ DB λ°±μ—…
- ν–¥ν›„ AWS KMS / GCP Cloud HSMμΌλ΅ μ—…κ·Έλ μ΄λ“ κ²€ν† 

### 5. λΈλΌμ°μ € μ €μ¥μ† μμ΅΄μ„±

**ν•κ³„**: DEKλ” IndexedDBμ— μΊμ‹λ©λ‹λ‹¤. λΈλΌμ°μ € λ°μ΄ν„°λ¥Ό μ‚­μ ν•λ©΄ PINμ„ λ‹¤μ‹ μ…λ ¥ν•΄μ•Ό ν•©λ‹λ‹¤.

**μ™ λ°›μ•„λ“¤μ€λ”κ°€**: DEKλ¥Ό λ§¤λ² μ„λ²„μ—μ„ λ°›μ•„μ¤λ©΄ λ„¤νΈμ›ν¬ μ§€μ—°μ΄ λ°μƒν•κ³ , μ¤ν”„λΌμΈ μ‚¬μ©μ΄ λ¶κ°€λ¥ν•©λ‹λ‹¤.

IndexedDBλ” localStorageλ³΄λ‹¤ μ•μ „ν•©λ‹λ‹¤:

- λ™μΌ μ¶μ² μ •μ±…(Same-origin policy) μ μ©
- XSS κ³µκ²©μ— μƒλ€μ μΌλ΅ κ°•ν•¨
- μ©λ‰ μ ν•μ΄ λ„‰λ„‰ν•¨

---

## κ·ΈλΌμ—λ„ μ΄ μ„¤κ³„λ¥Ό μ„ νƒν• μ΄μ 

λ¨λ“  ν•κ³„λ¥Ό μ•κ³ λ„ μ΄ μ„¤κ³„λ¥Ό μ„ νƒν• μ΄μ λ” ν•λ‚μ…λ‹λ‹¤:

> **μ‚¬μ©μμ κ°€μ¥ κ°μΈμ μΈ κΈ°λ΅μ€ λ³ΈμΈλ§ λ³Ό μ μμ–΄μ•Ό ν•©λ‹λ‹¤.**

μ„λ²„ μ΄μμμΈ λ‚΄κ°€ μ‚¬μ©μμ κΈ°λ΅μ„ μ—΄λν•  μ μλ‹¤λ©΄, μ‚¬μ©μλ” μ§„μ‹¬μ„ λ‹΄μ•„ κΈ°λ΅ν•κΈ° μ–΄λ µμµλ‹λ‹¤. λ¶νΈν•¨μ„ κ°μν•λ”λΌλ„ ν”„λΌμ΄λ²„μ‹λ¥Ό μ§€ν‚¤λ” κ²ƒμ΄ μ΄ μ„λΉ„μ¤μ ν•µμ‹¬ κ°€μΉμ…λ‹λ‹¤.

| ν¬κΈ°ν• κ²ƒ     | μ–»μ€ κ²ƒ                     |
|-----------|--------------------------|
| μ„λ²„ μΈ΅ κ²€μƒ‰   | DB μ μ¶λ§μΌλ΅λ” ν‰λ¬Έ λ³µμ› λ¶κ°€       |
| κ΄€λ¦¬μ λ³µκµ¬ κΈ°λ¥ | μ„λ²„ λ‹¨λ…μΌλ΅ ν‰λ¬Έ μ ‘κ·Ό λ¶κ°€         |
| μΌλ¶€ νΈμ κΈ°λ¥  | μ„λ²„ μΉ¨ν•΄ μ‹μ—λ„ μ¶”κ°€ λ°©μ–΄μ„ (KDF) μ΅΄μ¬ |

---

## κµ¬ν„ μ°Έμ΅°

| νμΌ                                       | μ—­ν•                         |
|------------------------------------------|---------------------------|
| `src/shared/lib/crypto/keyDerivation.ts` | Client KEK νμƒ (PBKDF2)    |
| `src/shared/lib/crypto/hkdf.ts`          | Combined KEK μƒμ„±           |
| `src/shared/lib/crypto/dek.ts`           | DEK μƒμ„±/μ•”νΈν™”/λ³µνΈν™”            |
| `src/shared/lib/crypto/crypto.ts`        | λ°μ΄ν„° μ•”νΈν™”/λ³µνΈν™” (AES-256-GCM) |
| `src/shared/lib/crypto/recoveryKey.ts`   | Recovery Key μƒμ„±/κ²€μ¦        |
| `src/shared/lib/dekCache.ts`             | DEK λΈλΌμ°μ € μΊμ‹± (IndexedDB)   |

---

## κ²°λ΅ 

Selahμ E2E μ•”νΈν™”λ” **"μ„λ²„λ¥Ό μ‹ λΆ°ν•μ§€ μ•λ”λ‹¤"**λ” μ „μ μ—μ„ μ¶λ°ν–μµλ‹λ‹¤.

1. **OAuth νΈν™**: λ΅κ·ΈμΈ λΉ„λ°€λ²νΈ λ€μ‹  λ³„λ„μ 6μλ¦¬ PIN μ‚¬μ©
2. **DB μ μ¶ λ°©μ–΄**: Server Key κ²°ν•©μΌλ΅ DB λ‹¨λ… μ μ¶ μ‹ μ¤ν”„λΌμΈ κ³µκ²© μ°¨λ‹¨
3. **ν‰λ¬Έ λΉ„μ €μ¥**: μ„λ²„λ” μ•”νΈλ¬Έλ§ μ €μ¥ν•λ©°, λ³µνΈν™” ν‚¤λ” μ‚¬μ©μ μ…λ ¥(PIN/Recovery Key)μ— μμ΅΄

μ„λ²„ DBκ°€ μ μ¶λμ–΄λ„ ν‰λ¬Έ λ³µμ›μ΄ μ–΄λ µκ³ , μ„λ²„ λ‹¨λ…μΌλ΅λ” μ‚¬μ©μ λ°μ΄ν„°μ— μ ‘κ·Όν•  μ μ—†μµλ‹λ‹¤. λ‹¨, μ„λ²„(Master Key ν¬ν•¨) μ „μ²΄κ°€ μΉ¨ν•΄λλ” κ²½μ° PIN μ—”νΈλ΅ν”Ό ν•κ³„κ°€ μ΅΄μ¬ν•λ©°, μ΄λ” KDF λΉ„μ©κ³Ό μ΄μ
λ³΄μ•(ν–¥ν›„ KMS/HSM)μΌλ΅ μ™„ν™”ν•©λ‹λ‹¤.
